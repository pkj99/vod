<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="coi-serviceworker.js"></script>
    <title>FFmpeg.wasm 影音播放器</title>
    
    <script src="js/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; line-height: 1.6; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f9f9f9; }
        .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #333; font-size: 1.5rem; text-align: center; }
        .upload-section { border: 2px dashed #007bff; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; }
        video { width: 100%; border-radius: 8px; background: #000; margin-top: 20px; }
        #log { background: #333; color: #00ff00; padding: 10px; border-radius: 5px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 10px; }
        .progress-bar { width: 100%; background: #eee; height: 10px; border-radius: 5px; margin-top: 10px; display: none; }
        #progress-inner { width: 0%; height: 100%; background: #007bff; border-radius: 5px; transition: width 0.3s; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="card">
    <h1>高效能 Web 端影片轉碼播放器</h1>
    <p style="font-size: 0.9rem; color: #666;">支援格式：MKV, AVI, MOV / 音訊：AC3, DTS, AAC</p>

    <div class="upload-section">
        <input type="file" id="uploader" accept="video/*" />
        <p id="message">正在初始化 FFmpeg 引擎...</p>
    </div>

    <div id="controls" style="display: none; text-align: center;">
        <button id="startBtn">開始轉碼並播放</button>
        <div class="progress-bar" id="progressBar"><div id="progress-inner"></div></div>
    </div>

    <div id="log">系統日誌待命中...</div>

    <video id="player" controls></video>
</div>

<script>
    const { FFmpeg } = FFmpegWasm;
    const { fetchFile, toBlobURL } = FFmpegUtil;

    const ffmpeg = new FFmpeg();
    const message = document.getElementById('message');
    const logElement = document.getElementById('log');
    const startBtn = document.getElementById('startBtn');
    const progInner = document.getElementById('progress-inner');
    const player = document.getElementById('player');

    // 輔助函式：更新 Log
    function addLog(msg) {
        const div = document.createElement('div');
        div.textContent = `> ${msg}`;
        logElement.appendChild(div);
        logElement.scrollTop = logElement.scrollHeight;
    }

    // 1. 初始化 FFmpeg
    async function init() {
        try {
            // const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
            const baseURL = 'js';
            await ffmpeg.load({
                coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
                wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
            });
            message.innerText = "引擎就緒！請選擇檔案。";
            document.getElementById('controls').style.display = 'block';
            addLog("FFmpeg WebAssembly 核心載入成功");
        } catch (err) {
            addLog("初始化失敗: " + err.message);
            message.innerText = "初始化失敗，請檢查網路或瀏覽器支援。";
        }
    }

    // 監聽轉碼進度
    ffmpeg.on('progress', ({ progress, time }) => {
        const percent = (progress * 100).toFixed(2);
        progInner.style.width = `${percent}%`;
        addLog(`處理中: ${percent}% (時間: ${time / 1000000}s)`);
    });

    // 監聽日誌輸出
    ffmpeg.on('log', ({ message }) => {
        console.log(message);
    });

    // 2. 轉碼與播放邏輯
    startBtn.onclick = async () => {
        const file = document.getElementById('uploader').files[0];
        if (!file) {
            alert("請先選擇影片檔案！");
            return;
        }

        startBtn.disabled = true;
        document.getElementById('progressBar').style.display = 'block';
        addLog(`開始讀取檔案: ${file.name}`);

        // 將檔案寫入 MEMFS (記憶體檔案系統)
        await ffmpeg.writeFile('input_file', await fetchFile(file));

        addLog("正在執行轉碼指令 (Copy Video + AAC Audio)...");

        /**
         * 指令說明：
         * -i: 輸入檔案
         * -c:v copy: 視訊流直接複製（不耗費 CPU，保持原始畫質）
         * -c:a aac: 音訊流強制轉為 AAC（解決 AC3 無聲問題）
         * -strict experimental: 確保相容性
         */
        await ffmpeg.exec([
            '-i', 'input_file', 
            '-c:v', 'copy', 
            '-c:a', 'aac', 
            'output.mp4'
        ]);

        addLog("轉碼完成，準備匯出...");

        const data = await ffmpeg.readFile('output.mp4');
        const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
        
        player.src = url;
        addLog("影片已成功加載至播放器！");
        
        startBtn.disabled = false;
        progInner.style.width = '100%';
    };

    init();
</script>

</body>
</html>